<!DOCTYPE html>
<html lang="tg">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bozorcha Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{font-family:sans-serif;background:#f4f4f4;margin:0}
.post{background:white;margin:10px;padding:10px;border-radius:10px}
input,textarea,button{width:100%;padding:10px;margin-top:10px}
button{background:#ff9800;color:white;border:none;border-radius:6px}
</style>
</head>

<body>

<h2 style="padding:10px">Bozorcha</h2>

<button onclick="openAddModal()">+ Иловаи маҳсулот</button>

<div id="posts"></div>

<!-- MODAL -->
<div id="modal" style="display:none;background:#0008;position:fixed;inset:0;padding:20px;">
<div style="background:white;padding:20px;border-radius:10px">

<h3>Интихоби категория</h3>
<div id="categories"></div>

<div id="form"></div>

<button onclick="closeModal()">Пӯшидан</button>

</div>
</div>

<script>
const SB_URL = "https://seagtlaujnnhoyitgsdd.supabase.co";
const SB_KEY = "sb_publishable_OILChtOja0i8nIrPZuM_Og_vyfGjfsP";

const db = supabase.createClient(SB_URL, SB_KEY);

let selectedCategory = null;

function openAddModal(){
document.getElementById("modal").style.display="block";
loadCategories(null);
}

function closeModal(){
document.getElementById("modal").style.display="none";
document.getElementById("form").innerHTML="";
}

async function loadCategories(parent){
let q = db.from("categories").select("*");
parent ? q=q.eq("parent_id",parent) : q=q.is("parent_id",null);

const {data}=await q;

const box=document.getElementById("categories");
box.innerHTML="";

if(data.length===0){
showForm(parent);
return;
}

data.forEach(c=>{
const b=document.createElement("button");
b.innerText=c.name_tg;
b.onclick=()=>loadCategories(c.id);
box.appendChild(b);
});
}

async function showForm(catId){
selectedCategory=catId;

document.getElementById("categories").innerHTML="<b>Категория интихоб шуд</b>";

const {data:fields}=await db
.from("category_fields")
.select("*")
.eq("category_id",catId);

let html=`
<input id="name" placeholder="Ном">
<input id="price" type="number" placeholder="Нарх">
`;

fields.forEach(f=>{
html+=`<input id="field_${f.id}" placeholder="${f.label_tg}">`;
});

html+=`
<textarea id="desc" placeholder="Тавсиф"></textarea>
<button onclick="saveProduct()">Сабт</button>
`;

document.getElementById("form").innerHTML=html;
}

async function saveProduct(){
const name=document.getElementById("name").value;
const price=document.getElementById("price").value;
const desc=document.getElementById("desc").value;

await db.from("products").insert({
name:name,
price:price,
description:desc,
category_id:selectedCategory
});

closeModal();
loadProducts();
}

async function loadProducts(){
const {data}=await db.from("products").select("*").order("created_at",{ascending:false});

const box=document.getElementById("posts");
box.innerHTML="";

data.forEach(p=>{
box.innerHTML+=`
<div class="post">
<b>${p.name}</b><br>
${p.price} c.<br>
${p.description||""}
</div>
`;
});
}

loadProducts();
</script>

</body>
</html>
