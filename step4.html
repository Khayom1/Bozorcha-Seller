<!DOCTYPE html>
<html lang="tg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bozorcha Seller - Қадами 4</title>
    <!-- reCAPTCHA library -->
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    <!-- Supabase library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:sans-serif;}
        body{background:#f5f5f5;display:flex;justify-content:center;align-items:center;min-height:100vh;padding:10px;}
        .container{width:100%;max-width:375px;background:white;border-radius:30px;box-shadow:0 10px 30px rgba(0,0,0,0.1);padding:20px;}
        .section-title { font-size:16px;font-weight:bold;margin:15px 0;color:#333; }

        .upload-btn{
            display:block;width:100%;padding:18px;margin-bottom:12px;
            background:#fafafa;border:2px dashed #ddd;border-radius:15px;
            text-align:center;cursor:pointer;transition:0.3s;
        }
        .upload-btn.selected{border-color:#2196f3;background:#e3f2fd;color:#1565c0;}
        .upload-btn.done{border-color:#4caf50;background:#e8f5e9;color:#2e7d32;}

        input[type="file"]{display:none;}

        .recaptcha-wrapper {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }

        .submit-button{
            width:100%;padding:16px;background:#ccc;color:white;
            border:none;border-radius:12px;font-size:18px;
            font-weight:bold;cursor:not-allowed;margin-top:20px;
            transition:0.3s;
        }
        .submit-button.ready{background:#ff9800;cursor:pointer;}
    </style>
</head>
<body>
    <div class="container">
        <div class="section-title">Тасдиқи шахсият</div>

        <label class="upload-btn" id="lbl1">
            <span id="txt1">Акси пеши паспорт</span>
            <input type="file" accept="image/*" onchange="storeFile(this,'doc_front','lbl1','txt1')">
        </label>

        <label class="upload-btn" id="lbl2">
            <span id="txt2">Акси пушти паспорт</span>
            <input type="file" accept="image/*" onchange="storeFile(this,'doc_back','lbl2','txt2')">
        </label>

        <label class="upload-btn" id="lbl3">
            <span id="txt3">Селфи бо паспорт</span>
            <input type="file" accept="image/*" onchange="storeFile(this,'doc_selfie','lbl3','txt3')">
        </label>

        <div class="section-title">Усули доставка</div>

        <label style="display:flex;margin-bottom:10px;">
            <input type="checkbox" id="d1">
            <span style="margin-left:10px;">Доставкаи шахсӣ</span>
        </label>
        <label style="display:flex;margin-bottom:10px;">
            <input type="checkbox" id="d2">
            <span style="margin-left:10px;">Тавассути почта</span>
        </label>
        <label style="display:flex;margin-bottom:10px;">
            <input type="checkbox" id="d3">
            <span style="margin-left:10px;">Супоридани дастӣ</span>
        </label>

        <!-- reCAPTCHA widget бо Site Key -->
        <div class="recaptcha-wrapper">
            <div class="g-recaptcha" 
                 data-sitekey="6Ld6mnksAAAAAEwyfULfJ1-rja-3VPCO2pGWa1Ey" 
                 data-callback="onRecaptchaSuccess" 
                 data-expired-callback="onRecaptchaExpired">
            </div>
        </div>

        <button class="submit-button" id="submitBtn" disabled>Фиристодан</button>
    </div>

    <script>
        // Supabase бо Anon Key
        const supabaseClient = supabase.createClient(
            'https://seagtlaujnnhoyitgsdd.supabase.co',
            'sb_publishable_OlLChtOja0i8nIrPZuM_Og_vyfGjfsP'
        );

        let selectedFiles = {
            doc_front: null,
            doc_back: null,
            doc_selfie: null
        };
        let recaptchaPassed = false;

        function storeFile(input, key, labelId, textId) {
            const file = input.files[0];
            if (!file) return;

            selectedFiles[key] = file;

            const label = document.getElementById(labelId);
            const text = document.getElementById(textId);

            label.className = "upload-btn done";
            text.innerText = "✓ " + file.name;

            checkReady();
        }

        function onRecaptchaSuccess() {
            recaptchaPassed = true;
            checkReady();
        }

        function onRecaptchaExpired() {
            recaptchaPassed = false;
            checkReady();
        }

        function checkReady() {
            const btn = document.getElementById("submitBtn");
            const filesReady = selectedFiles.doc_front && selectedFiles.doc_back && selectedFiles.doc_selfie;
            const deliveryReady = document.getElementById('d1').checked || document.getElementById('d2').checked || document.getElementById('d3').checked;

            if (filesReady && deliveryReady && recaptchaPassed) {
                btn.disabled = false;
                btn.classList.add("ready");
            } else {
                btn.disabled = true;
                btn.classList.remove("ready");
            }
        }

        document.getElementById('d1').addEventListener('change', checkReady);
        document.getElementById('d2').addEventListener('change', checkReady);
        document.getElementById('d3').addEventListener('change', checkReady);

        document.getElementById("submitBtn").onclick = async function() {
            if (this.disabled) return;

            this.disabled = true;
            this.innerText = "Бор шуда истодааст...";

            try {
                async function uploadOne(file, folder) {
                    const fileName = Date.now() + "_" + file.name;
                    const { data, error } = await supabaseClient.storage
                        .from("documents")
                        .upload(folder + "/" + fileName, file);
                    if (error) throw error;
                    return data.path;
                }

                const [front, back, selfie] = await Promise.all([
                    uploadOne(selectedFiles.doc_front, "passports"),
                    uploadOne(selectedFiles.doc_back, "passports"),
                    uploadOne(selectedFiles.doc_selfie, "selfies")
                ]);

                const info = JSON.parse(localStorage.getItem("temp_seller_info") || "{}");

                const deliveries = [];
                if (document.getElementById("d1").checked) deliveries.push("Шахсӣ");
                if (document.getElementById("d2").checked) deliveries.push("Почта");
                if (document.getElementById("d3").checked) deliveries.push("Дастӣ");

                const { error } = await supabaseClient.from("sellers").insert([{
                    ...info,
                    doc_front: front,
                    doc_back: back,
                    doc_selfie: selfie,
                    delivery_methods: deliveries
                }]);

                if (error) throw error;

                alert("Ҳама чиз бо муваффақият иҷро шуд!");
                localStorage.clear();
                window.location.href = "index.html";

            } catch (err) {
                alert("Хато: " + err.message);
                this.disabled = false;
                this.innerText = "Фиристодан";
                grecaptcha.reset();
                recaptchaPassed = false;
                checkReady();
            }
        };
    </script>
</body>
</html>
