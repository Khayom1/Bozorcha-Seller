
<!DOCTYPE html>
<html lang="tg">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bozorcha Seller - “ö–∞–¥–∞–º–∏ 4</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:sans-serif;}
body{background:#f5f5f5;display:flex;justify-content:center;align-items:center;min-height:100vh;padding:10px;}
.container{width:100%;max-width:375px;background:white;border-radius:30px;box-shadow:0 10px 30px rgba(0,0,0,0.1);padding:20px;}
.section-title { font-size:16px;font-weight:bold;margin:15px 0;color:#333; }

.upload-btn{
display:block;width:100%;padding:18px;margin-bottom:12px;
background:#fafafa;border:2px dashed #ddd;border-radius:15px;
text-align:center;cursor:pointer;transition:0.3s;
}

.upload-btn.selected{border-color:#2196f3;background:#e3f2fd;color:#1565c0;}
.upload-btn.uploading{border-color:#ff9800;background:#fff3e0;color:#ef6c00;}
.upload-btn.done{border-color:#4caf50;background:#e8f5e9;color:#2e7d32;}

input[type="file"]{display:none;}

.submit-button{
width:100%;padding:16px;background:#ccc;color:white;
border:none;border-radius:12px;font-size:18px;
font-weight:bold;cursor:not-allowed;margin-top:20px;
}

.submit-button.ready{background:#ff9800;cursor:pointer;}
</style>
</head>

<body>

<div class="container">

<div class="section-title">–¢–∞—Å–¥–∏“õ–∏ —à–∞—Ö—Å–∏—è—Ç</div>

<label class="upload-btn" id="lbl1">
<span id="txt1">–ê–∫—Å–∏ –ø–µ—à–∏ –ø–∞—Å–ø–æ—Ä—Ç</span>
<input type="file" accept="image/*" onchange="storeFile(this,'doc_front','lbl1','txt1')">
</label>

<label class="upload-btn" id="lbl2">
<span id="txt2">–ê–∫—Å–∏ –ø—É—à—Ç–∏ –ø–∞—Å–ø–æ—Ä—Ç</span>
<input type="file" accept="image/*" onchange="storeFile(this,'doc_back','lbl2','txt2')">
</label>

<label class="upload-btn" id="lbl3">
<span id="txt3">–°–µ–ª—Ñ–∏ –±–æ –ø–∞—Å–ø–æ—Ä—Ç</span>
<input type="file" accept="image/*" onchange="storeFile(this,'doc_selfie','lbl3','txt3')">
</label>

<div class="section-title">–£—Å—É–ª–∏ –¥–æ—Å—Ç–∞–≤–∫–∞</div>

<label style="display:flex;margin-bottom:10px;">
<input type="checkbox" id="d1">
<span style="margin-left:10px;">–î–æ—Å—Ç–∞–≤–∫–∞–∏ —à–∞—Ö—Å”£</span>
</label>

<label style="display:flex;">
<input type="checkbox" id="d2">
<span style="margin-left:10px;">–¢–∞–≤–∞—Å—Å—É—Ç–∏ –ø–æ—á—Ç–∞</span>
</label>

<button class="submit-button" id="submitBtn" disabled>–§–∏—Ä–∏—Å—Ç–æ–¥–∞–Ω</button>

</div>

<script>

const supabaseClient = supabase.createClient(
'https://seagtlaujnnhoyitgsdd.supabase.co',
'sb_publishable_OlLChtOja0i8nIrPZuM_Og_vyfGjfsP'
);

// üîπ –§–∞–π–ª“≥–æ —Ç–∞–Ω“≥–æ –¥–∞—Ä RAM –Ω–∏–≥–æ“≥ –¥–æ—à—Ç–∞ –º–µ—à–∞–≤–∞–Ω–¥
let selectedFiles = {
doc_front:null,
doc_back:null,
doc_selfie:null
};

// üîπ –¢–∞–Ω“≥–æ –Ω–∏–≥–æ“≥–¥–æ—Ä”£ (upload –Ω–∞–º–µ–∫—É–Ω–∞–¥)
function storeFile(input,key,labelId,textId){

const file = input.files[0];
if(!file) return;

selectedFiles[key] = file;

const label = document.getElementById(labelId);
const text = document.getElementById(textId);

label.className = "upload-btn selected";
text.innerText = "‚úì –ò–Ω—Ç–∏—Ö–æ–± —à—É–¥";

checkReady();
}

// üîπ –§–∞—ä–æ–ª –∫–∞—Ä–¥–∞–Ω–∏ —Ç—É–≥–º–∞
function checkReady(){

const btn = document.getElementById("submitBtn");

if(selectedFiles.doc_front &&
   selectedFiles.doc_back &&
   selectedFiles.doc_selfie){

btn.disabled = false;
btn.classList.add("ready");
}
}

// üîπ –í–∞“õ—Ç–∏ submit ‚Äî upload + insert
document.getElementById("submitBtn").onclick = async function(){

this.disabled = true;
this.innerText = "–ë–æ—Ä —à—É–¥–∞ –∏—Å—Ç–æ–¥–∞–∞—Å—Ç...";

try{

async function uploadOne(file,folder){

const fileName = Date.now()+"_"+file.name;

const {data,error} = await supabaseClient.storage
.from("documents")
.upload(folder+"/"+fileName,file);

if(error) throw error;

return data.path;
}

// üî• Upload 3 —Ñ–∞–π–ª —è–∫“∑–æ
const [front,back,selfie] = await Promise.all([
uploadOne(selectedFiles.doc_front,"passports"),
uploadOne(selectedFiles.doc_back,"passports"),
uploadOne(selectedFiles.doc_selfie,"selfies")
]);

// üîπ –ú–∞—ä–ª—É–º–æ—Ç–∏ “õ–∞–¥–∞–º“≥–æ–∏ –ø–µ—à
const info = JSON.parse(localStorage.getItem("temp_seller_info") || "{}");

const deliveries = [];
if(document.getElementById("d1").checked) deliveries.push("–®–∞—Ö—Å”£");
if(document.getElementById("d2").checked) deliveries.push("–ü–æ—á—Ç–∞");

// üîπ Insert –±–∞ database
const {error} = await supabaseClient.from("sellers").insert([{
...info,
doc_front:front,
doc_back:back,
doc_selfie:selfie,
delivery_methods:deliveries
}]);

if(error) throw error;

alert("“≤–∞–º–∞ —á–∏–∑ –±–æ –º—É–≤–∞—Ñ—Ñ–∞“õ–∏—è—Ç –∏“∑—Ä–æ —à—É–¥!");
localStorage.clear();
window.location.href="index.html";

}catch(err){

alert("–•–∞—Ç–æ: "+err.message);
this.disabled = false;
this.innerText = "–§–∏—Ä–∏—Å—Ç–æ–¥–∞–Ω";
}

};

</script>

</body>
</html>
