<!DOCTYPE html>
<html lang="tg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bozorcha Seller - Қадами 4</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:sans-serif;}
        body{background:#f5f5f5;display:flex;justify-content:center;align-items:center;min-height:100vh;padding:10px;}
        .container{width:100%;max-width:380px;background:white;border-radius:20px;padding:20px;box-shadow:0 10px 25px rgba(0,0,0,0.1);}
        .upload-btn{display:block;width:100%;padding:16px;margin-bottom:10px;border:2px dashed #ccc;border-radius:12px;text-align:center;cursor:pointer;}
        .upload-btn.done{border-color:#4caf50;background:#e8f5e9;color:#2e7d32;}
        input[type="file"]{display:none;}
        .submit-button{width:100%;padding:16px;background:#ff9800;color:white;border:none;border-radius:12px;font-size:18px;font-weight:bold;margin-top:15px;cursor:pointer;}
        .submit-button:disabled{background:#ccc;cursor:not-allowed;}
    </style>
</head>
<body>
<div class="container">
    <div style="font-weight:bold; margin-bottom:15px;">Тасдиқи шахсият</div>
    <label class="upload-btn" id="lbl1">Акси пеши паспорт <input type="file" accept="image/*" onchange="storeFile(this,'doc_front','lbl1')"></label>
    <label class="upload-btn" id="lbl2">Акси пушти паспорт <input type="file" accept="image/*" onchange="storeFile(this,'doc_back','lbl2')"></label>
    <label class="upload-btn" id="lbl3">Селфи бо паспорт <input type="file" accept="image/*" onchange="storeFile(this,'doc_selfie','lbl3')"></label>

    <div style="margin:15px 0;">
        <label><input type="checkbox" id="d1"> Доставкаи шахсӣ</label><br>
        <label><input type="checkbox" id="d2"> Тавассути почта</label>
    </div>

    <button class="submit-button" id="submitBtn">Фиристодан</button>
</div>

<script>
const supabaseClient = supabase.createClient(
    'https://seagtlaujnnhoyitgsdd.supabase.co',
    'sb_publishable_OlLChtOja0i8nIrPZuM_Og_vyfGjfsP'
);

let selectedFiles = {doc_front:null, doc_back:null, doc_selfie:null};

function storeFile(input, key, labelId){
    const file = input.files[0];
    if(file) {
        selectedFiles[key] = file;
        const lbl = document.getElementById(labelId);
        lbl.classList.add("done");
        lbl.innerText = "✓ " + file.name.substring(0, 15);
    }
}

document.getElementById("submitBtn").onclick = async function(){
    if(!selectedFiles.doc_front || !selectedFiles.doc_back || !selectedFiles.doc_selfie){
        alert("Ҳамаи аксҳоро интихоб кунед.");
        return;
    }

    this.disabled = true;
    this.innerText = "Бор шуда истодааст...";

    try {
        // ХОНДАНИ МАЪЛУМОТ АЗ STEP 3
        const rawData = localStorage.getItem('temp_seller_info');
        if(!rawData) throw new Error("Маълумоти Step 3 ёфт нашуд.");
        const info = JSON.parse(rawData);

        // ФУНКСИЯИ БОРКУНИИ АКС БА STORAGE
        async function uploadOne(file, folder){
            const fileName = Date.now() + "_" + file.name.replace(/\s/g, '_');
            const { data, error } = await supabaseClient.storage
                .from("documents")
                .upload(folder + "/" + fileName, file);
            if(error) throw error;
            return data.path;
        }

        // БОРКУНИИ ҲАМАИ АКСҲО
        const [p1, p2, p3] = await Promise.all([
            uploadOne(selectedFiles.doc_front, "passports"),
            uploadOne(selectedFiles.doc_back, "passports"),
            uploadOne(selectedFiles.doc_selfie, "selfies")
        ]);

        const deliveries = [];
        if(document.getElementById("d1").checked) deliveries.push("Шахсӣ");
        if(document.getElementById("d2").checked) deliveries.push("Почта");

        // САБТ ДАР БАЗА (TABLE: sellers)
        const { error: dbError } = await supabaseClient.from("sellers").insert([{
            name: info.name,
            surname: info.surname,
            phone: info.phone,
            city: info.city,
            district: info.district,
            street: info.street,
            house: info.house,
            shop_name: info.shop,
            doc_front: p1,
            doc_back: p2,
            doc_selfie: p3,
            delivery_methods: deliveries,
            status: 'pending'
        }]);

        if(dbError) throw dbError;

        alert("Бақайдгирӣ бо муваффақият анҷом ёфт!");
        localStorage.clear();
        window.location.href = "dashboard.html";

    } catch(err) {
        alert("Хатогӣ: " + err.message);
        this.disabled = false;
        this.innerText = "Фиристодан";
    }
};
</script>
</body>
</html>
