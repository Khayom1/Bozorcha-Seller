<!DOCTYPE html>
<html lang="tg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Қадами 4 - Тасдиқ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:sans-serif;}
        body{background:#f5f5f5;display:flex;justify-content:center;align-items:center;min-height:100vh;padding:10px;}
        .container{width:100%;max-width:375px;background:white;border-radius:30px;box-shadow:0 10px 30px rgba(0,0,0,0.1);padding:20px;}
        .section-title { font-size: 16px; font-weight: bold; margin: 15px 0; color: #333; }
        .upload-btn {
            display: block; width: 100%; padding: 15px; margin-bottom: 10px;
            background: #fafafa; border: 1px solid #ddd; border-radius: 12px;
            text-align: center; cursor: pointer; transition: 0.3s;
        }
        .upload-btn.done { background: #e8f5e9; border-color: #4caf50; color: #2e7d32; }
        input[type="file"] { display: none; }
        .checkbox-container {
            width: 22px; height: 22px; border: 2px solid #ff9800; border-radius: 6px;
            margin-right: 12px; cursor: pointer; transition: 0.2s;
        }
        .checkbox-container:active { transform: scale(0.8); }
        input[type="checkbox"] { display: none; }
        input[type="checkbox"]:checked + .checkbox-container { background: #ff9800; }
        .submit-button {
            width: 100%; padding: 16px; background: #ff9800; color: white;
            border: none; border-radius: 12px; font-size: 18px; font-weight: bold;
            cursor: pointer; margin-top: 20px;
        }
        .submit-button:disabled { background: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="container">
        <div class="section-title">Тасдиқи шахсият</div>
        <label class="upload-btn" id="lbl1">Акси пеши паспорт <input type="file" id="f1" accept="image/*" onchange="updateStatus('f1', 'lbl1')"></label>
        <label class="upload-btn" id="lbl2">Акси пушти паспорт <input type="file" id="f2" accept="image/*" onchange="updateStatus('f2', 'lbl2')"></label>
        <label class="upload-btn" id="lbl3">Селфи бо паспорт <input type="file" id="f3" accept="image/*" onchange="updateStatus('f3', 'lbl3')"></label>

        <div class="section-title">Усули доставка</div>
        <label style="display:flex; align-items:center; margin-bottom:10px;">
            <input type="checkbox" id="d1"><div class="checkbox-container"></div><span>Доставкаи шахсӣ</span>
        </label>
        <label style="display:flex; align-items:center;">
            <input type="checkbox" id="d2"><div class="checkbox-container"></div><span>Тавассути почта</span>
        </label>

        <button class="submit-button" id="submitBtn" disabled>Фиристодан</button>
    </div>

    <script>
        const _supabase = supabase.createClient('https://seagtlaujnnhoyitgsdd.supabase.co', 'sb_publishable_OlLChtOja0i8nIrPZuM_Og_vyfGjfsP');

        function updateStatus(inputId, labelId) {
            const input = document.getElementById(inputId);
            const label = document.getElementById(labelId);
            if (input.files[0]) {
                label.classList.add('done');
                label.innerText = "✓ " + input.files[0].name.substring(0, 15);
                checkForm();
            }
        }

        function checkForm() {
            const f1 = document.getElementById('f1').files.length;
            const f2 = document.getElementById('f2').files.length;
            const f3 = document.getElementById('f3').files.length;
            // Тугма танҳо вақте рангин (фаъол) мешавад, ки 3 акс бошад
            document.getElementById('submitBtn').disabled = !(f1 && f2 && f3);
        }

        async function uploadFile(file, folder) {
            const path = `${folder}/${Date.now()}_${file.name}`;
            const { data, error } = await _supabase.storage.from('documents').upload(path, file);
            if (error) throw error;
            return path;
        }

        document.getElementById('submitBtn').onclick = async function() {
            this.disabled = true;
            this.innerText = "Ирсол...";

            try {
                const info = JSON.parse(localStorage.getItem('temp_seller_info'));
                const p1 = await uploadFile(document.getElementById('f1').files[0], 'passports');
                const p2 = await uploadFile(document.getElementById('f2').files[0], 'passports');
                const p3 = await uploadFile(document.getElementById('f3').files[0], 'selfies');

                const deliveries = [];
                if(document.getElementById('d1').checked) deliveries.push("Шахсӣ");
                if(document.getElementById('d2').checked) deliveries.push("Почта");

                const { error } = await _supabase.from('sellers').insert([{
                    ...info,
                    doc_front: p1,
                    doc_back: p2,
                    doc_selfie: p3,
                    delivery_methods: deliveries
                }]);

                if (error) throw error;
                alert("Муваффақият!");
                localStorage.clear();
                window.location.href = 'index.html';
            } catch (err) {
                alert("Хатогӣ: " + err.message);
                this.disabled = false;
                this.innerText = "Фиристодан";
            }
        };
    </script>
</body>
</html>
