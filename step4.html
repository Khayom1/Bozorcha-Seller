<!DOCTYPE html>
<html lang="tg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bozorcha Seller - Қадами 4</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:sans-serif;}
        body{background:#f5f5f5;display:flex;justify-content:center;align-items:center;min-height:100vh;padding:10px;}
        .container{width:100%;max-width:375px;background:white;border-radius:30px;box-shadow:0 10px 30px rgba(0,0,0,0.1);padding:20px;}
        .section-title { font-size: 16px; font-weight: bold; margin: 15px 0; color: #333; }
        .upload-btn {
            display: block; width: 100%; padding: 18px; margin-bottom: 12px;
            background: #fafafa; border: 2px dashed #ddd; border-radius: 15px;
            text-align: center; cursor: pointer; transition: 0.3s; position: relative;
        }
        .upload-btn.uploading { border-color: #ff9800; background: #fffde7; color: #f57c00; }
        .upload-btn.done { border-color: #4caf50; border-style: solid; background: #e8f5e9; color: #2e7d32; }
        input[type="file"] { display: none; }
        .submit-button {
            width: 100%; padding: 16px; background: #ccc; color: white;
            border: none; border-radius: 12px; font-size: 18px; font-weight: bold;
            cursor: not-allowed; margin-top: 20px;
        }
        .submit-button.ready { background: #ff9800; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <div class="section-title">Тасдиқи шахсият</div>
        
        <label class="upload-btn" id="lbl1">
            <span id="txt1">Акси пеши паспорт</span>
            <input type="file" id="f1" accept="image/*" onchange="startRealUpload(this, 'lbl1', 'txt1', 'doc_front')">
        </label>

        <label class="upload-btn" id="lbl2">
            <span id="txt2">Акси пушти паспорт</span>
            <input type="file" id="f2" accept="image/*" onchange="startRealUpload(this, 'lbl2', 'txt2', 'doc_back')">
        </label>

        <label class="upload-btn" id="lbl3">
            <span id="txt3">Селфи бо паспорт</span>
            <input type="file" id="f3" accept="image/*" onchange="startRealUpload(this, 'lbl3', 'txt3', 'doc_selfie')">
        </label>

        <div class="section-title">Усули доставка</div>
        <label style="display:flex; margin-bottom:10px;"><input type="checkbox" id="d1"> <span style="margin-left:10px;">Доставкаи шахсӣ</span></label>
        <label style="display:flex;"><input type="checkbox" id="d2"> <span style="margin-left:10px;">Тавассути почта</span></label>

        <button class="submit-button" id="submitBtn" disabled>Фиристодан</button>
    </div>

    <script>
        const _supabase = supabase.createClient('https://seagtlaujnnhoyitgsdd.supabase.co', 'sb_publishable_OlLChtOja0i8nIrPZuM_Og_vyfGjfsP');
        
        // Нигоҳдории роҳҳои аксҳо пас аз боркунии воқеӣ
        let paths = { doc_front: null, doc_back: null, doc_selfie: null };

        async function startRealUpload(input, labelId, textId, key) {
            const file = input.files[0];
            if (!file) return;

            const label = document.getElementById(labelId);
            const text = document.getElementById(textId);

            // 1. Оғози боркунӣ (Ҳолати визуалӣ)
            label.className = 'upload-btn uploading';
            text.innerText = "Бор шуда истодааст...";
            input.disabled = true; // Пешгирӣ аз интихоби дубора ҳангоми боркунӣ

            try {
                const folder = key === 'doc_selfie' ? 'selfies' : 'passports';
                const fileName = `${Date.now()}_${file.name}`;
                const filePath = `${folder}/${fileName}`;

                // 2. Ирсоли воқеӣ ба Supabase Storage
                const { data, error } = await _supabase.storage
                    .from('documents')
                    .upload(filePath, file);

                if (error) throw error;

                // 3. Анҷоми боркунӣ (Муваффақият)
                paths[key] = data.path;
                label.className = 'upload-btn done';
                text.innerText = "✓ Бор шуд";
                
                checkReady();
            } catch (err) {
                // Ҳолати хатогӣ
                label.className = 'upload-btn';
                text.innerText = "Хатогӣ! Дубора кӯшиш кунед";
                input.disabled = false;
                alert("Хатогӣ: " + err.message);
            }
        }

        function checkReady() {
            const btn = document.getElementById('submitBtn');
            if (paths.doc_front && paths.doc_back && paths.doc_selfie) {
                btn.disabled = false;
                btn.classList.add('ready');
            }
        }

        document.getElementById('submitBtn').onclick = async function() {
            this.disabled = true;
            this.innerText = "Сабт шуда истодааст...";

            try {
                const info = JSON.parse(localStorage.getItem('temp_seller_info') || '{}');
                const deliveries = [];
                if(document.getElementById('d1').checked) deliveries.push("Шахсӣ");
                if(document.getElementById('d2').checked) deliveries.push("Почта");

                const { error } = await _supabase.from('sellers').insert([{
                    ...info,
                    ...paths,
                    delivery_methods: deliveries,
                    status: 'pending'
                }]);

                if (error) throw error;

                alert("Ҳамаи маълумот бо муваффақият сабт шуд!");
                localStorage.clear();
                window.location.href = 'index.html';
            } catch (err) {
                alert("Хатогӣ ҳангоми сабт: " + err.message);
                this.disabled = false;
                this.innerText = "Фиристодан";
            }
        };
    </script>
</body>
</html>
