<!DOCTYPE html>
<html lang="tg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bozorcha Seller - Қадами 4</title>
    <!-- Supabase JavaScript library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:sans-serif;}
        body{background:#f5f5f5;display:flex;justify-content:center;align-items:center;min-height:100vh;padding:10px;}
        .phone-container{width:100%;max-width:375px;background:white;border-radius:30px;box-shadow:0 10px 30px rgba(0,0,0,0.1);overflow:hidden;animation:fadeIn 0.5s ease;}
        @keyframes fadeIn{0%{opacity:0;transform:translateY(10px);}100%{opacity:1;transform:translateY(0);}}
        .app-bar{display:flex;align-items:center;padding:15px 20px;border-bottom:1px solid #f0f0f0;}
        .back-button{font-size:24px;color:#333;width:30px;text-align:center;text-decoration:none;color:#333;transition:opacity 0.2s;}
        .back-button:active{opacity:0.6;}
        .app-title{flex:1;text-align:center;font-weight:bold;font-size:18px;color:#333;}
        .content{padding:20px;animation:slideIn 0.4s ease;}
        @keyframes slideIn{0%{opacity:0;transform:translateX(-10px);}100%{opacity:1;transform:translateX(0);}}
        .step-indicator{display:flex;justify-content:center;margin-bottom:30px;}
        .step-badge{background:#fff3e0;color:#ff9800;font-size:14px;padding:5px 15px;border-radius:20px;}
        .title{font-size:18px;font-weight:bold;margin:15px 0 10px;}
        .file-upload{margin-bottom:15px;}
        .file-label{display:block;padding:12px;border:1px solid #e0e0e0;border-radius:12px;background:#fafafa;cursor:pointer;text-align:center;transition:all 0.3s ease;}
        .file-label:hover{background:#f0f0f0;}
        .file-label:active{transform:scale(0.98);}
        .file-label.done{background:#e8f5e8;border-color:green;}
        .file-label input{display:none;}
        .file-name{font-size:12px;color:#666;margin-top:4px;text-align:center;animation:fadeIn 0.3s;}
        .checkbox-item{display:flex;align-items:center;margin-bottom:10px;transition:transform 0.2s;}
        .checkbox-item:active{transform:scale(0.98);}
        .checkbox-item input{width:20px;height:20px;margin-right:10px;cursor:pointer;}
        .finish-button{width:100%;padding:16px;background:#ff9800;color:white;border:none;border-radius:12px;font-size:18px;font-weight:bold;cursor:pointer;margin-top:20px;transition:all 0.2s ease;}
        .finish-button:hover{background:#f57c00;}
        .finish-button:active{transform:scale(0.97);}
        .footer{padding:20px;text-align:center;font-size:12px;color:#bdbdbd;border-top:1px solid #f0f0f0;}
    </style>
</head>
<body>
    <div class="phone-container">
        <div class="app-bar">
            <a href="step3.html" class="back-button">←</a>
            <div class="app-title">Bozorcha Seller</div>
            <div style="width:30px;"></div>
        </div>
        <div class="content">
            <div class="step-indicator"><span class="step-badge">Қадами 4 аз 4</span></div>
            <div class="title">Тасдиқи шахсият</div>
            
            <div class="file-upload" id="frontContainer">
                <label class="file-label" id="frontLabel">
                    Акси пеши паспорт
                    <input type="file" id="frontFile" accept="image/*" onchange="handleFile(this, 'front')">
                </label>
                <div class="file-name" id="frontName"></div>
            </div>
            
            <div class="file-upload" id="backContainer">
                <label class="file-label" id="backLabel">
                    Акси пушти паспорт
                    <input type="file" id="backFile" accept="image/*" onchange="handleFile(this, 'back')">
                </label>
                <div class="file-name" id="backName"></div>
            </div>
            
            <div class="file-upload" id="selfieContainer">
                <label class="file-label" id="selfieLabel">
                    Селфи бо паспорт
                    <input type="file" id="selfieFile" accept="image/*" onchange="handleFile(this, 'selfie')">
                </label>
                <div class="file-name" id="selfieName"></div>
            </div>
            
            <div class="title">Усули доставка</div>
            <div class="checkbox-item"><input type="checkbox" id="del1"><label for="del1">Доставкаи шахсӣ</label></div>
            <div class="checkbox-item"><input type="checkbox" id="del2"><label for="del2">Тавассути почта</label></div>
            <div class="checkbox-item"><input type="checkbox" id="del3"><label for="del3">Супоридани дастӣ</label></div>
            
            <button class="finish-button" id="finishBtn">Фиристодан</button>
        </div>
        <div class="footer">© 2026 Bozorcha. Ҳама ҳуқуқ маҳфуз аст.</div>
    </div>
    <script>
        // Инициализатсияи Supabase
        const SUPABASE_URL = 'https://seagtlaujnnhoyitgsdd.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_OlLChtOja0i8nIrPZuM_Og_vyfGjfsP';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let uploaded = {front: false, back: false, selfie: false};

        window.handleFile = function(input, type) {
            if (input.files && input.files[0]) {
                let fileName = input.files[0].name;
                document.getElementById(type + 'Name').innerText = '✓ ' + fileName;
                document.getElementById(type + 'Label').classList.add('done');
                uploaded[type] = true;
            } else {
                document.getElementById(type + 'Name').innerText = '';
                document.getElementById(type + 'Label').classList.remove('done');
                uploaded[type] = false;
            }
        };

        // Паёми оддӣ барои дидани ҳолат
        alert('Саҳифаи 4 бор шуд. Акнун санҷиши Supabase...');

        // Санҷиши пайвастшавӣ ба Supabase
        async function testConnection() {
            try {
                const { data, error } = await supabase.from('user').select('count', { count: 'exact', head: true });
                if (error) throw error;
                alert('✅ Пайвастшавӣ ба Supabase дуруст аст! Таблицаи user ёфт шуд.');
            } catch (e) {
                alert('❌ Хатогӣ дар пайвастшавӣ: ' + e.message);
            }
        }

        // Санҷишро фавран иҷро кун
        testConnection();

        document.getElementById('finishBtn').onclick = async function() {
            alert('Тугма кор мекунад. Маълумот ҷамъоварӣ мешавад...');
            
            if (!uploaded.front || !uploaded.back || !uploaded.selfie) {
                alert('Ҳар се аксро бор кунед');
                return;
            }
            
            let del1 = document.getElementById('del1').checked;
            let del2 = document.getElementById('del2').checked;
            let del3 = document.getElementById('del3').checked;
            if (!del1 && !del2 && !del3) {
                alert('Ҳадди ақал як усули доставкаро интихоб кунед');
                return;
            }

            // Ҷамъоварии маълумот аз LocalStorage
            const userData = {
                phone: localStorage.getItem('bozorcha_phone') || '',
                name: localStorage.getItem('bozorcha_name') || '',
                surname: localStorage.getItem('bozorcha_surname') || '',
                shop_name: localStorage.getItem('bozorcha_shop') || '',
                city: localStorage.getItem('bozorcha_city') || 'Душанбе',
                district: localStorage.getItem('bozorcha_district') || 'Сино',
                street: localStorage.getItem('bozorcha_street') || '',
                house: localStorage.getItem('bozorcha_house') || '',
                delivery_self: del1,
                delivery_post: del2,
                delivery_pickup: del3
            };

            alert('Маълумот барои фиристодан омода аст. Фиристода истодаам...');

            try {
                // Фиристодани маълумот ба Supabase
                const { data: userDataResult, error: userError } = await supabase
                    .from('user')  // ТАҒЙИР: 'users' → 'user'
                    .insert([userData])
                    .select();

                if (userError) throw userError;

                alert('✅ Маълумот бомуваффақият фиристода шуд!');
                window.location.href = 'index.html';
                
            } catch (error) {
                alert('❌ Хатогӣ: ' + error.message);
                console.error('Error:', error);
            }
        };

        // Нишон додани хатогӣ дар саҳифа
        window.onerror = function(message, source, lineno, colno, error) {
            alert("Хатогӣ дар саҳифа: " + message);
            return true;
        };
    </script>
</body>
</html>
