<!DOCTYPE html>
<html lang="tg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bozorcha Seller - Қадами 4</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:sans-serif;}
        body{background:#f5f5f5;display:flex;justify-content:center;align-items:center;min-height:100vh;padding:10px;}
        .container{width:100%;max-width:380px;background:white;border-radius:20px;padding:20px;box-shadow:0 10px 25px rgba(0,0,0,0.1);}
        .section-title { font-size: 16px; font-weight: bold; margin-bottom: 15px; color: #333; }
        .upload-btn{display:block;width:100%;padding:16px;margin-bottom:10px;border:2px dashed #ccc;border-radius:12px;text-align:center;cursor:pointer;transition: 0.3s;}
        .upload-btn.done{border-color:#4caf50;background:#e8f5e9;color: #2e7d32;}
        input[type="file"]{display:none;}
        .delivery-section { margin: 15px 0; }
        .delivery-option { display: flex; align-items: center; margin-bottom: 8px; cursor: pointer; }
        .submit-button{width:100%;padding:16px;background:#ff9800;color:white;border:none;border-radius:12px;font-size:18px;font-weight:bold;margin-top:15px;cursor:pointer;transition: 0.3s;}
        .submit-button:disabled { background: #ccc; cursor: not-allowed; }
        .captcha-box { background: #fff3e0; padding: 15px; border-radius: 12px; margin-top: 15px; }
    </style>
</head>
<body>
<div class="container">
    <div class="section-title">Тасдиқи шахсият</div>
    <label class="upload-btn" id="lbl1">Акси пеши паспорт <input type="file" accept="image/*" onchange="storeFile(this,'doc_front','lbl1')"></label>
    <label class="upload-btn" id="lbl2">Акси пушти паспорт <input type="file" accept="image/*" onchange="storeFile(this,'doc_back','lbl2')"></label>
    <label class="upload-btn" id="lbl3">Селфи бо паспорт <input type="file" accept="image/*" onchange="storeFile(this,'doc_selfie','lbl3')"></label>

    <div class="delivery-section">
        <div class="section-title">Усули доставка</div>
        <label class="delivery-option"><input type="checkbox" id="d1" style="margin-right:10px;"> Доставкаи шахсӣ</label>
        <label class="delivery-option"><input type="checkbox" id="d2" style="margin-right:10px;"> Тавассути почта</label>
    </div>

    <div class="captcha-box">
        <label id="captchaQuestion" style="font-weight:bold; display:block; margin-bottom:5px;"></label>
        <input type="number" id="captchaAnswer" placeholder="Ҷавобро ворид кунед" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px;">
    </div>

    <button class="submit-button" id="submitBtn">Фиристодан</button>
</div>

<script>
const supabaseClient = supabase.createClient(
    'https://seagtlaujnnhoyitgsdd.supabase.co',
    'sb_publishable_OlLChtOja0i8nIrPZuM_Og_vyfGjfsP'
);

let selectedFiles = {doc_front:null, doc_back:null, doc_selfie:null};

function storeFile(input, key, labelId){
    const file = input.files[0];
    if(!file) return;
    selectedFiles[key] = file;
    const label = document.getElementById(labelId);
    label.classList.add("done");
    label.innerText = "✓ " + file.name.substring(0, 15) + "...";
}

// Simple Captcha Logic
let captchaA = Math.floor(Math.random()*10)+1;
let captchaB = Math.floor(Math.random()*10)+1;
let captchaResult = captchaA + captchaB;
document.getElementById("captchaQuestion").innerText = `Ҳисоб кунед: ${captchaA} + ${captchaB} = ?`;

document.getElementById("submitBtn").onclick = async function(){
    const userAnswer = parseInt(document.getElementById("captchaAnswer").value);
    
    // Валидатсия
    if(userAnswer !== captchaResult){
        alert("Ҷавоби Captcha нодуруст аст.");
        return;
    }
    if(!selectedFiles.doc_front || !selectedFiles.doc_back || !selectedFiles.doc_selfie){
        alert("Лутфан ҳамаи 3 аксро интихоб кунед.");
        return;
    }
    if(!document.getElementById("d1").checked && !document.getElementById("d2").checked){
        alert("Ақаллан як усули доставкаро интихоб кунед.");
        return;
    }

    this.disabled = true;
    this.innerText = "Дар ҳоли боркунӣ...";

    try {
        // 1. Хондани маълумоти воқеӣ аз LocalStorage
        const rawData = localStorage.getItem('temp_seller_info');
        if (!rawData) throw new Error("Маълумоти ибтидоӣ ёфт нашуд. Лутфан аз аввал оғоз кунед.");
        
        const info = JSON.parse(rawData);

        // 2. Функсияи боркунии файл ба Storage
        async function uploadOne(file, folder){
            const fileName = `${Date.now()}_${file.name.replace(/\s/g, '_')}`;
            const { data, error } = await supabaseClient.storage
                .from("documents")
                .upload(`${folder}/${fileName}`, file);
            if(error) throw error;
            return data.path;
        }

        // Боркунии ҳамзамони аксҳо
        const [front, back, selfie] = await Promise.all([
            uploadOne(selectedFiles.doc_front, "passports"),
            uploadOne(selectedFiles.doc_back, "passports"),
            uploadOne(selectedFiles.doc_selfie, "selfies")
        ]);

        const deliveries = [];
        if(document.getElementById("d1").checked) deliveries.push("Шахсӣ");
        if(document.getElementById("d2").checked) deliveries.push("Почта");

        // 3. Сабти ниҳоӣ дар ҷадвали 'sellers'
        const { error: dbError } = await supabaseClient.from("sellers").insert([{
            name: info.name,
            surname: info.surname,
            phone: info.phone,
            city: info.city,
            district: info.district,
            street: info.street,
            house: info.house,
            shop_name: info.shop || '', // Мувофиқи калиди 'shop' аз Step 3
            doc_front: front,
            doc_back: back,
            doc_selfie: selfie,
            delivery_methods: deliveries,
            status: 'pending'
        }]);

        if(dbError) throw dbError;

        alert("Муваффақият! Маълумоти шумо фиристода шуд.");
        localStorage.clear();
        window.location.href = "index.html";

    } catch(err) {
        alert("Хатогӣ: " + err.message);
        this.disabled = false;
        this.innerText = "Фиристодан";
    }
};
</script>
</body>
</html>
